<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/default-layout}"
      layout:fragment="article">
<style> .row { margin-bottom: 10px; } </style>
<article id="article-board-main">
	<p id="article-title">
		WRITE
	</p>
	
	<div class="row">
      <label class="col-sm-2 col-form-label">TITLE</label>
      <div class="col-sm-10">
		<input type="text" id="write-title" class="form-control">
      </div>
    </div>
	
	<div class="row">
      <label class="col-sm-2 col-form-label">THUMBNAIL</label>
      <div class="col-sm-10">
        <input type="file" id="thumbnail" class="form-control" accept="image/*" onchange="thumnailPreview(this)">
      </div>
    </div>
	
	<img id="thumbnail-preview" alt="썸네일 미리보기"></img>
	
	<textarea id="editor"></textarea>
	<!-- <div id="editor"></div> -->
	
	<div id="btn-grp">
		<button type="button" id="btn-cancel" class="btn btn-danger">CANCEL</button>
		<button type="button" id="btn-write" class="btn btn-success">WRITE</button>
	</div>
</article>

<script th:inline="javascript">
	let $btnWrite = $('#btn-write');
	let $data = ([[${DATA}]] || '');
	let $iboard = ($data.iboard || '');
	let $code = ($data.icode != '' ? $data.icode : [[${param.code}]]);

	// SimpleMDE 웹에디터 초기화
	var editor = new SimpleMDE({
		element: $("#editor")[0]
	});
	
	// 썸네일 미리보기
	function thumnailPreview(file) {
		let thumbnail = file.files[0];
		
		if(thumbnail) {
			let reader = new FileReader();
			
			reader.onload = function(e) {
				let thumbnailPreview = $('#thumbnail-preview');
				thumbnailPreview.attr('src', e.target.result);
				thumbnailPreview.css('display', 'block');
			};
			
			reader.readAsDataURL(thumbnail);
		}
	}
	
	if($iboard != '') {
		$('#btn-write').html('UPDATE');
		$('#article-title').html('UPDATE');
		$('#write-title').val($data.title);
		editor.value($data.contents);
		
		$('#btn-write').attr('id', 'btn-update');
	}
	
	$('#btn-update').click(() => {
		if(confirm('게시글을 수정하시겠습니까?')) {
			let title = $('#write-title').val();
			let contents = editor.value();
			let dto = {iboard : $iboard, title : title, contents : contents};
			
			$.ajax({
				type		: 'PATCH',
				url			: '/board/update-md',
				data		: JSON.stringify(dto),
				contentType	: 'application/json',
				success		: (data) => {
					const RESULT = data.RESULT;
					
					if(RESULT == 1) {
						alert('게시글이 수정되었습니다.');
						location.href = '/board/read-md?iboard=' + $iboard;
					} else {
						alert('게시글 수정에 실패하였습니다.');
						return;
					}
				}, error	: (err) => {
					console.log('err = ', err);
				}
			})
		}
	});
	
	$btnWrite.click(() => {
		let paramCode = `[[${param.code}]]`;
		let code = paramCode.replace(/[\[\]"]/g, '');
		let title = $('#write-title').val();
		let contents = editor.value();
		let thumbnail = $('#thumbnail')[0].files[0];
		
		let formData = new FormData();
		formData.append("thumbnail", thumbnail);
		formData.append("icode", code);
		formData.append("title", title);
		formData.append("contents", contents);
		
		$.ajax({
			type		: 'POST',
			url			: '/board/write-md',
			data		: formData,
			processData : false,
			contentType	: false,
			success		: (data) => {
				const RESULT = data.RESULT;
				
				if(RESULT == 1) {
					alert('게시글이 등록되었습니다.');
					location.href = '/board/list?code=' + code;
				} else {
					alert('게시글 등록에 실패하였습니다.');
					return;
				}
			}, error	: (err) => {
				console.log('err = ', err);
			}
		})
	});
	
	/*
	$btnWrite.click(() => {
		let paramCode = `[[${param.code}]]`;
		let code = paramCode.replace(/[\[\]"]/g, '');
		let title = $('#write-title').val();
		let contents = editor.value();
		let thumbnail = file.files[0];
		let dto = {icode : code, title : title, contents : contents};
		
		$.ajax({
			type		: 'POST',
			url			: '/board/write-md',
			data		: JSON.stringify(dto),
			contentType	: 'application/json',
			success		: (data) => {
				const RESULT = data.RESULT;
				
				if(RESULT == 1) {
					alert('게시글이 등록되었습니다.');
					location.href = '/board/list?code=' + code;
				} else {
					alert('게시글 등록에 실패하였습니다.');
					return;
				}
			}, error	: (err) => {
				console.log('err = ', err);
			}
		})
	});
	*/
	
	$('#btn-cancel').click(() => {
		if(confirm('게시글 작성을 취소하고 목록으로 돌아가시겠습니까?')) {
			location.href = '/board/list?code=' + $code;
		}
	});
</script>
</html>